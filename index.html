<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tarjeta Virtual</title>
    <meta name="description" content="Mi tarjeta de d√©bito virtual con cafeter√≠a">
    <meta name="theme-color" content="#10b981">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%2310b981'/><text x='50' y='60' font-size='60' text-anchor='middle' fill='white'>üí≥</text></svg>">
    <link rel="apple-touch-icon" href="https://i.ibb.co/5Yk2t0X/icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { touch-action: manipulation; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f3f4f6; margin: 0; }
        input, select, button { -webkit-appearance: none; appearance: none; outline: none; }

        #cafeteriaBtn {
            position: fixed; right: 1rem; bottom: 1.5rem; width: 56px; height: 56px;
            background: linear-gradient(135deg, #f59e0b, #f97316); color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; box-shadow: 0 4px 15px rgba(249,115,22,0.4); z-index: 1000;
            cursor: pointer; transition: all 0.2s;
        }
        #cafeteriaBtn:active { transform: scale(0.95); }

        #cafeteriaWindow {
            position: fixed; right: 1rem; bottom: 5rem; width: 280px; max-height: 70vh;
            background: white; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            overflow: hidden; z-index: 999; transform: scale(0); transform-origin: bottom right;
            transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
        }
        #cafeteriaWindow.open { transform: scale(1); }

        .cafeteria-header { background: linear-gradient(135deg, #f59e0b, #f97316); color: white; padding: 0.75rem 1rem; font-weight: 600; text-align: center; }
        .menu-scroll { max-height: 55vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .cafeteria-item { display: flex; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; gap: 0.75rem; }
        .cafeteria-item:last-child { border-bottom: none; }
        .cafeteria-item img { width: 50px; height: 50px; object-fit: cover; border-radius: 10px; }
        .cafeteria-info { flex: 1; }
        .cafeteria-name { font-weight: 600; font-size: 0.95rem; }
        .cafeteria-price { color: #16a34a; font-weight: bold; font-size: 0.9rem; }
        .stock { font-size: 0.75rem; }
        .stock-low { color: #dc2626; }
        .stock-medium { color: #f59e0b; }
        .stock-high { color: #10b981; }
        .order-btn { background: #10b981; color: white; font-size: 0.8rem; padding: 0.35rem 0.6rem; border-radius: 8px; font-weight: 600; }
        .order-btn:active { background: #059669; }
        .order-btn:disabled { background: #9ca3af; cursor: not-allowed; }

        .transaction-item { background: white; margin: 0.5rem 1rem; padding: 1rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .transaction-item.ingreso { border-left: 4px solid #10b981; }
        .transaction-item.gasto { border-left: 4px solid #ef4444; }
        
        .loading { opacity: 0.6; pointer-events: none; }
        .success-message { background: #10b981; color: white; padding: 10px; border-radius: 8px; margin: 10px; text-align: center; }
        .error-message { background: #ef4444; color: white; padding: 10px; border-radius: 8px; margin: 10px; text-align: center; }
    </style>
</head>
<body class="bg-gray-50">

    <div id="appContent">
        <!-- Login -->
        <div id="loginContainer" class="p-6 max-w-md mx-auto">
            <h1 class="text-2xl font-bold text-center text-green-800 mb-6">Iniciar Sesi√≥n</h1>
            <input type="text" id="username" placeholder="Usuario" class="w-full p-4 mb-3 border border-gray-300 rounded-xl text-lg">
            <input type="password" id="password" placeholder="Contrase√±a" class="w-full p-4 mb-5 border border-gray-300 rounded-xl text-lg">
            <button onclick="login()" class="w-full bg-green-600 text-white p-4 rounded-xl font-bold text-lg">Iniciar Sesi√≥n</button>
            <button onclick="showRegister()" class="w-full bg-blue-600 text-white p-4 rounded-xl mt-3 font-bold text-lg">Registrarse</button>
        </div>

        <!-- Registro -->
        <div id="registerContainer" class="p-6 max-w-md mx-auto hidden">
            <h1 class="text-2xl font-bold text-center text-green-800 mb-6">Registrarse</h1>
            <input type="text" id="regUsername" placeholder="Usuario" class="w-full p-4 mb-3 border border-gray-300 rounded-xl text-lg">
            <input type="password" id="regPassword" placeholder="Contrase√±a (m√≠n. 6)" class="w-full p-4 mb-3 border border-gray-300 rounded-xl text-lg">
            <input type="text" id="regFullName" placeholder="Nombre Completo" class="w-full p-4 mb-5 border border-gray-300 rounded-xl text-lg">
            <button onclick="register()" class="w-full bg-green-600 text-white p-4 rounded-xl font-bold text-lg">Registrarse</button>
            <button onclick="showLogin()" class="w-full bg-gray-500 text-white p-4 rounded-xl mt-3 font-bold text-lg">Ya tengo cuenta</button>
        </div>

        <!-- Principal -->
        <div id="mainContainer" class="hidden">
            <!-- Tarjeta -->
            <div class="mx-4 mt-4 bg-gradient-to-br from-green-500 to-green-700 rounded-2xl p-5 text-white shadow-xl">
                <p class="text-sm opacity-90">Titular</p>
                <p class="text-lg font-bold" id="cardHolder">Juan P√©rez</p>
                <p class="text-xl font-mono mt-3 tracking-wider" id="cardNumber">1234 5678 9012 3456</p>
                <div class="flex justify-between mt-4 text-sm">
                    <div><p class="opacity-90">Vence</p><p id="expiryDate">12/28</p></div>
                    <div><p class="opacity-90">CVV</p><p id="cvv">123</p></div>
                </div>
            </div>

            <!-- Saldo -->
            <div class="mx-4 mt-5 bg-white rounded-2xl p-5 shadow text-center">
                <p class="text-gray-600 text-sm">Saldo Actual</p>
                <p class="text-4xl font-bold text-green-600">$<span id="balance">0.00</span></p>
            </div>

            <!-- Filtros + Reporte -->
            <div class="mx-4 mt-5 bg-white rounded-2xl p-4 shadow">
                <select id="filterCategory" onchange="filterTransactions()" class="w-full p-3 mb-2 border border-gray-300 rounded-xl text-lg">
                    <option value="all">Todas</option>
                    <option value="general">General</option>
                    <option value="alimentaci√≥n">Alimentaci√≥n</option>
                    <option value="transporte">Transporte</option>
                    <option value="entretenimiento">Entretenimiento</option>
                    <option value="salud">Salud</option>
                    <option value="otros">Otros</option>
                </select>
                <input type="date" id="startDate" onchange="filterTransactions()" class="w-full p-3 mb-2 border border-gray-300 rounded-xl text-lg">
                <input type="date" id="endDate" onchange="filterTransactions()" class="w-full p-3 border border-gray-300 rounded-xl text-lg">
                <button onclick="generateReport()" class="w-full bg-teal-600 text-white p-3 rounded-xl mt-3 font-bold">Generar Reporte</button>
            </div>

            <!-- Formulario Transacci√≥n -->
            <div class="mx-4 mt-5 bg-white rounded-2xl p-5 shadow">
                <input type="number" id="amount" placeholder="Monto" step="0.01" class="w-full p-4 mb-3 border border-gray-300 rounded-xl text-lg">
                <select id="type" class="w-full p-4 mb-3 border border-gray-300 rounded-xl text-lg">
                    <option value="ingreso">Ingreso</option>
                    <option value="gasto">Gasto</option>
                </select>
                <select id="category" class="w-full p-4 mb-3 border border-gray-300 rounded-xl text-lg">
                    <option value="general">General</option>
                    <option value="alimentaci√≥n">Alimentaci√≥n</option>
                    <option value="transporte">Transporte</option>
                    <option value="entretenimiento">Entretenimiento</option>
                    <option value="salud">Salud</option>
                    <option value="otros">Otros</option>
                </select>
                <input type="date" id="date" class="w-full p-4 mb-3 border border-gray-300 rounded-xl text-lg">
                <input type="text" id="description" placeholder="Descripci√≥n" class="w-full p-4 mb-4 border border-gray-300 rounded-xl text-lg">
                <button onclick="addTransaction()" id="addTransactionBtn" class="w-full bg-green-600 text-white p-4 rounded-xl font-bold text-lg">Agregar Transacci√≥n</button>
            </div>

            <!-- Mensajes -->
            <div id="messageContainer"></div>

            <!-- Historial -->
            <div id="transactionList" class="mx-4 mt-5 mb-32"></div>

            <!-- Cerrar Sesi√≥n fijo -->
            <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 shadow-lg">
                <button onclick="logout()" class="w-full bg-red-600 text-white p-3 rounded-xl font-bold text-lg">Cerrar Sesi√≥n</button>
            </div>
        </div>
    </div>

    <!-- Bot√≥n Cafeter√≠a -->
    <div id="cafeteriaBtn" class="hidden" onclick="toggleCafeteria()">‚òï</div>

    <!-- Ventana Cafeter√≠a -->
    <div id="cafeteriaWindow">
        <div class="cafeteria-header">Men√∫ del D√≠a</div>
        <div class="menu-scroll" id="menuList"></div>
    </div>

    <script>
        let balance = 0;
        let transactions = [];
        let currentFilteredTransactions = [];
        let currentUser = null; // Para almacenar info del usuario

        const menuItems = [
            { name: "Caf√© Espresso", price: 2.50, stock: 18, img: "https://images.unsplash.com/photo-1577968893704-920e1e4e8e52?w=100&h=100&fit=crop" },
            { name: "Medialuna", price: 1.80, stock: 7, img: "https://images.unsplash.com/photo-1550583724-b2692b723b94?w=100&h=100&fit=crop" },
            { name: "Jugo de Naranja", price: 3.00, stock: 12, img: "https://images.unsplash.com/photo-1600271886715-8d5603491194?w=100&h=100&fit=crop" },
            { name: "Tostado Jam√≥n y Queso", price: 5.50, stock: 3, img: "https://images.unsplash.com/photo-1528735602780-2552fd46c7af?w=100&h=100&fit=crop" },
            { name: "Agua Mineral", price: 1.50, stock: 25, img: "https://images.unsplash.com/photo-1593253787488-2c6a2073e7db?w=100&h=100&fit=crop" }
        ];

        // Funci√≥n para mostrar mensajes
        function showMessage(message, type = 'success') {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            container.appendChild(messageDiv);
            
            // Auto-remover despu√©s de 3 segundos
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        function renderMenu() {
            const list = document.getElementById('menuList');
            list.innerHTML = '';
            menuItems.forEach((item, i) => {
                const stockClass = item.stock > 15 ? 'stock-high' : item.stock > 5 ? 'stock-medium' : 'stock-low';
                const disabled = item.stock === 0 ? 'disabled' : '';
                const div = document.createElement('div');
                div.className = 'cafeteria-item';
                div.innerHTML = `
                    <img src="${item.img}" alt="${item.name}">
                    <div class="cafeteria-info">
                        <div class="cafeteria-name">${item.name}</div>
                        <div class="cafeteria-price">$${item.price.toFixed(2)}</div>
                        <div class="stock ${stockClass}">Stock: ${item.stock}</div>
                    </div>
                    <button class="order-btn" ${disabled} onclick="orderItem(${i})">Pedir</button>
                `;
                list.appendChild(div);
            });
        }

        function orderItem(i) {
            const item = menuItems[i];
            if (item.stock === 0 || balance < item.price) {
                alert(balance < item.price ? 'Saldo insuficiente' : 'Sin stock');
                return;
            }
            if (confirm(`¬øPedir ${item.name} por $${item.price.toFixed(2)}?`)) {
                balance -= item.price;
                item.stock--;
                document.getElementById('balance').textContent = balance.toFixed(2);
                renderMenu();
                addTransactionAuto(item.price, 'gasto', 'alimentaci√≥n', new Date().toISOString().split('T')[0], `Cafeter√≠a: ${item.name}`);
            }
        }

        async function addTransactionAuto(amount, type, category, date, description) {
            if (!currentUser || !currentUser.id) {
                console.error('No hay usuario logueado para transacci√≥n de cafeter√≠a');
                return;
            }

            try {
                const response = await fetch('https://tarjeta-backend.onrender.com/transactions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        amount, 
                        type, 
                        category, 
                        date, 
                        description,
                        userId: currentUser.id
                    })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Error del servidor');
                }

                if (result.success) {
                    await loadTransactions();
                    showMessage('Compra en cafeter√≠a registrada');
                }
            } catch (error) {
                console.error('Error en compra cafeter√≠a:', error);
                showMessage('Error registrando compra: ' + error.message, 'error');
            }
        }

        function toggleCafeteria() {
            document.getElementById('cafeteriaWindow').classList.toggle('open');
        }

        function showCafeteriaButton() {
            document.getElementById('cafeteriaBtn').classList.remove('hidden');
            renderMenu();
        }

        // === FILTROS Y REPORTE ===
        function filterTransactions() {
            const cat = document.getElementById('filterCategory').value;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            
            let filtered = transactions;
            
            if (cat !== 'all') {
                filtered = filtered.filter(t => t.category === cat);
            }
            if (start) {
                filtered = filtered.filter(t => t.date >= start);
            }
            if (end) {
                filtered = filtered.filter(t => t.date <= end);
            }
            
            currentFilteredTransactions = filtered;
            renderTransactions(filtered);
        }

        function renderTransactions(list = transactions) {
            const container = document.getElementById('transactionList');
            container.innerHTML = '';
            
            if (list.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">No hay transacciones</div>';
                return;
            }
            
            list.forEach(t => {
                const div = document.createElement('div');
                div.className = `transaction-item ${t.type}`;
                div.innerHTML = `
                    <div class="flex justify-between">
                        <span class="font-medium">${new Date(t.date).toLocaleDateString('es-ES')}</span>
                        <span class="${t.type === 'ingreso' ? 'text-green-600' : 'text-red-600'} font-bold">
                            ${t.type === 'ingreso' ? '+' : '-'}$${parseFloat(t.amount).toFixed(2)}
                        </span>
                    </div>
                    <div class="text-sm text-gray-600 mt-1">${t.category} | ${t.description}</div>
                `;
                container.appendChild(div);
            });
        }

        function generateReport() {
            const cat = document.getElementById('filterCategory').value;
            const start = document.getElementById('startDate').value || 'N/A';
            const end = document.getElementById('endDate').value || 'N/A';
            
            let filtered = currentFilteredTransactions.length > 0 ? currentFilteredTransactions : transactions;
            
            let report = `Reporte de Transacciones\n`;
            report += `========================================\n`;
            report += `Saldo: $${balance.toFixed(2)}\n`;
            report += `Filtros: ${cat}, ${start} - ${end}\n\n`;
            
            filtered.forEach(t => {
                report += `${t.date} | ${t.type} | $${parseFloat(t.amount).toFixed(2)} | ${t.description}\n`;
            });
            
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'reporte.txt';
            a.click();
            URL.revokeObjectURL(url);
            
            showMessage('Reporte generado y descargado');
        }

        // === AUTH SIN JWT (simplificado) ===
        function showRegister() { 
            document.getElementById('loginContainer').classList.add('hidden'); 
            document.getElementById('registerContainer').classList.remove('hidden'); 
        }
        
        function showLogin() { 
            document.getElementById('registerContainer').classList.add('hidden'); 
            document.getElementById('loginContainer').classList.remove('hidden'); 
        }

        async function register() {
            const u = document.getElementById('regUsername').value.trim();
            const p = document.getElementById('regPassword').value;
            const n = document.getElementById('regFullName').value.trim();
            
            if (!u || !p || !n || p.length < 6) {
                showMessage('Complete todos los campos (m√≠n. 6 caracteres en contrase√±a)', 'error');
                return;
            }

            try {
                const res = await fetch('https://tarjeta-backend.onrender.com/auth/register', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ username: u, password: p, fullName: n }) 
                });
                
                const data = await res.json();
                
                if (data.success) {
                    const user = data.user;
                    currentUser = user; // Guardar usuario actual
                    
                    document.getElementById('cardHolder').textContent = user.fullName;
                    document.getElementById('cardNumber').textContent = user.cardNumber;
                    document.getElementById('cvv').textContent = user.cvv;
                    document.getElementById('expiryDate').textContent = user.expiryDate;
                    document.getElementById('registerContainer').classList.add('hidden');
                    document.getElementById('mainContainer').classList.remove('hidden');
                    showCafeteriaButton();
                    await loadTransactions();
                    showMessage('Registro exitoso');
                } else {
                    showMessage(data.error, 'error');
                }
            } catch (error) {
                console.error('Error en registro:', error);
                showMessage('Error de conexi√≥n', 'error');
            }
        }

        async function login() {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value;
            
            if (!u || !p) {
                showMessage('Complete usuario y contrase√±a', 'error');
                return;
            }

            try {
                const res = await fetch('https://tarjeta-backend.onrender.com/auth/login', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ username: u, password: p }) 
                });
                
                const data = await res.json();
                
                if (data.success) {
                    const user = data.user;
                    currentUser = user; // Guardar usuario actual
                    
                    document.getElementById('cardHolder').textContent = user.fullName;
                    document.getElementById('cardNumber').textContent = user.cardNumber;
                    document.getElementById('cvv').textContent = user.cvv;
                    document.getElementById('expiryDate').textContent = user.expiryDate;
                    document.getElementById('loginContainer').classList.add('hidden');
                    document.getElementById('mainContainer').classList.remove('hidden');
                    showCafeteriaButton();
                    await loadTransactions();
                    showMessage('Bienvenido');
                } else {
                    showMessage(data.error, 'error');
                }
            } catch (error) {
                console.error('Error en login:', error);
                showMessage('Error de conexi√≥n', 'error');
            }
        }

        function logout() {
            currentUser = null; // Limpiar usuario
            document.getElementById('mainContainer').classList.add('hidden');
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('cafeteriaBtn').classList.add('hidden');
            document.getElementById('cafeteriaWindow').classList.remove('open');
            showMessage('Sesi√≥n cerrada');
        }

        async function loadTransactions() {
            if (!currentUser || !currentUser.id) {
                console.error('No hay usuario logueado');
                return;
            }

            try {
                console.log('Cargando transacciones para usuario:', currentUser.id);
                const response = await fetch(`https://tarjeta-backend.onrender.com/transactions/${currentUser.id}`);
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                transactions = Array.isArray(data) ? data : [];
                
                console.log('Transacciones cargadas:', transactions.length);
                console.log('Ejemplo de transacci√≥n:', transactions[0]);
                
                // Calcular balance correctamente
                balance = transactions.reduce((acc, transaction) => {
                    const amount = parseFloat(transaction.amount);
                    // Normalizar el tipo por si hay inconsistencias
                    const type = transaction.type.toLowerCase().replace('√≠ngreso', 'ingreso');
                    return type === 'ingreso' 
                        ? acc + amount
                        : acc - amount;
                }, 0);
                
                document.getElementById('balance').textContent = balance.toFixed(2);
                renderTransactions();
                
            } catch (error) {
                console.error('Error cargando transacciones:', error);
                transactions = [];
                balance = 0;
                document.getElementById('balance').textContent = '0.00';
                renderTransactions();
                showMessage('Error cargando transacciones: ' + error.message, 'error');
            }
        }

        async function addTransaction() {
            if (!currentUser || !currentUser.id) {
                showMessage('No hay usuario logueado', 'error');
                return;
            }

            const amountInput = document.getElementById('amount');
            const typeInput = document.getElementById('type');
            const categoryInput = document.getElementById('category');
            const dateInput = document.getElementById('date');
            const descriptionInput = document.getElementById('description');
            const button = document.getElementById('addTransactionBtn');
            
            const a = parseFloat(amountInput.value);
            const t = typeInput.value;
            const c = categoryInput.value;
            const d = dateInput.value;
            const desc = descriptionInput.value.trim();

            // Validaciones m√°s robustas
            if (!a || a <= 0 || isNaN(a)) {
                showMessage('Ingrese un monto v√°lido mayor a 0', 'error');
                amountInput.focus();
                return;
            }
            
            if (!d) {
                showMessage('Seleccione una fecha', 'error');
                dateInput.focus();
                return;
            }
            
            if (!desc) {
                showMessage('Ingrese una descripci√≥n', 'error');
                descriptionInput.focus();
                return;
            }

            try {
                // Mostrar loading
                button.disabled = true;
                button.textContent = 'Agregando...';
                button.classList.add('loading');

                console.log('Enviando transacci√≥n para usuario:', currentUser.id);
                console.log('Datos:', { amount: a, type: t, category: c, date: d, description: desc, userId: currentUser.id });

                const response = await fetch('https://tarjeta-backend.onrender.com/transactions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        amount: a, 
                        type: t, 
                        category: c, 
                        date: d, 
                        description: desc,
                        userId: currentUser.id
                    })
                });

                const result = await response.json();
                
                console.log('Respuesta del servidor:', result);
                
                if (!response.ok) {
                    // Mostrar detalles del error del servidor
                    let errorMessage = result.error || 'Error del servidor';
                    if (result.details) {
                        errorMessage += `: ${result.details}`;
                    }
                    throw new Error(errorMessage);
                }

                if (result.success) {
                    // Limpiar formulario
                    amountInput.value = '';
                    descriptionInput.value = '';
                    // Mantener la fecha actual
                    dateInput.value = new Date().toISOString().split('T')[0];
                    
                    // Recargar transacciones
                    await loadTransactions();
                    showMessage('Transacci√≥n agregada correctamente');
                } else {
                    throw new Error(result.error || 'Error desconocido');
                }
                
            } catch (error) {
                console.error('Error completo al agregar transacci√≥n:', error);
                showMessage('Error: ' + error.message, 'error');
            } finally {
                // Restaurar bot√≥n
                button.disabled = false;
                button.textContent = 'Agregar Transacci√≥n';
                button.classList.remove('loading');
            }
        }

        // Inicializaci√≥n
        window.onload = () => {
            // Establecer fecha actual por defecto
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            
            console.log('Aplicaci√≥n iniciada');
        };
    </script>
</body>
</html>